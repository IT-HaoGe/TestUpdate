name: Windows10_LTSC2019_x86

on: workflow_dispatch
#on: [push, pull_request]

env:
  FILE_NAME: Windows10_LTSC2019_x86

jobs:
  Windows10_LTSC2019_x86:
    runs-on: windows-latest

    steps:

    # æ£€å‡ºæœ¬ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v5

    # 2. è¯»å– PSD1 å¹¶éªŒè¯
    - name: Read Version from PSD1
      shell: pwsh
      run: |
        # --- åœ¨è¿™é‡Œä¿®æ”¹ä½ æƒ³æµ‹è¯•çš„ Key ---
        $TargetKey = "LTSC2019"
        $Psd1File  = "versions.psd1"
        # ----------------------------

        # 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (-not (Test-Path $Psd1File)) {
            Write-Error "âŒ é”™è¯¯: æ‰¾ä¸åˆ° $Psd1File æ–‡ä»¶ï¼è¯·ç¡®è®¤æ–‡ä»¶åœ¨ä»“åº“æ ¹ç›®å½•ã€‚"
            exit 1
        }

        # 2. å®‰å…¨å¯¼å…¥ PSD1 æ•°æ®
        try {
            $data = Import-PowerShellDataFile -Path $Psd1File
        } catch {
            Write-Error "âŒ PSD1 æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯­æ³• (ä¾‹å¦‚æ˜¯å¦æ¼äº†å¼•å·æˆ–åˆ†å·)ã€‚"
            Write-Error $_
            exit 1
        }

        # 3. æ£€æŸ¥ Key æ˜¯å¦å­˜åœ¨
        if (-not $data.ContainsKey($TargetKey)) {
            Write-Error "âŒ é”™è¯¯: åœ¨ $Psd1File ä¸­æ‰¾ä¸åˆ°é”®å '$TargetKey'"
            Write-Host "ğŸ’¡ å½“å‰æ–‡ä»¶åŒ…å«çš„é”®: $($data.Keys -join ', ')"
            exit 1
        }

        # 4. è·å–å€¼å¹¶æ‰“å°
        $ver = $data[$TargetKey]
        
        Write-Host "----------------------------------------"
        Write-Host "âœ… è¯»å–æˆåŠŸï¼"
        Write-Host "ğŸ“‚ æ–‡ä»¶å: $Psd1File"
        Write-Host "ğŸ”‘ é”®å (Key): $TargetKey"
        Write-Host "ğŸ”¢ ç‰ˆæœ¬å· (Value): $ver"
        Write-Host "----------------------------------------"

        # 5. å†™å…¥ç¯å¢ƒå˜é‡
        "Build_VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append

    # æ£€å‡ºWin_ISO_Patching_Scriptsä»“åº“
    - name: Checkout repository of Win_ISO_Patching_Scripts
      # ...

    # æ£€å‡ºWin_ISO_Patching_Scriptsä»“åº“
    - name: Checkout repository of Win_ISO_Patching_Scripts
      run: |
        cd ..  #Directory: D:\a\TestUpdate
        git clone https://github.com/adavak/Win_ISO_Patching_Scripts.git

    # ä¸‹è½½é•œåƒ
    - name: download ISO
      shell: pwsh
      run: |
        #ls     #Directory: D:\a\TestUpdate\TestUpdate(å³ä»“åº“ç›®å½•)
        
        # åˆ‡æ¢è‡³Win_ISO_Patching_Scriptsæ ¹ç›®å½• D:\a\TestUpdate\Win_ISO_Patching_Scripts
        cd ..  #Directory: D:\a\TestUpdate
        cd Win_ISO_Patching_Scripts
        
        # ä¸‹è½½ ISO
        curl -L `
          -o cn_windows_10_enterprise_ltsc_2019_x86_dvd_1814dbab.iso `
          https://archive.isdn.network/windows/cn_windows_10_enterprise_ltsc_2019_x86_dvd_1814dbab.iso

        # æŸ¥çœ‹ç»“æœ
        ls *.iso

    # é›†æˆæ›´æ–°
    - name: Update WinISO
      shell: cmd
      run: |
        :: (å¯é€‰)æ›¿æ¢é¢„è®¾æ–‡ä»¶W10UI.ini
        :: copy D:\a\TestUpdate\TestUpdate\myini\W10UI.ini D:\a\TestUpdate\Win_ISO_Patching_Scripts\W10UI.ini /Y

        :: æ›¿æ¢W10UI.cmd
        copy D:\a\TestUpdate\TestUpdate\mycmd\W10UI.cmd D:\a\TestUpdate\Win_ISO_Patching_Scripts\W10UI.cmd /Y


        :: æ›¿æ¢ Scripts æ–‡ä»¶å¤¹
        :: ä½¿ç”¨ xcopy è¿›è¡Œæ–‡ä»¶å¤¹å¤åˆ¶
        xcopy D:\a\TestUpdate\TestUpdate\Scripts D:\a\TestUpdate\Win_ISO_Patching_Scripts\Scripts /E /Y /I

        :: åˆ‡æ¢è‡³Win_ISO_Patching_Scriptsæ ¹ç›®å½• D:\a\TestUpdate\Win_ISO_Patching_Scripts
        cd /d D:\a\TestUpdate\Win_ISO_Patching_Scripts

        :: å¼€å§‹é›†æˆæ›´æ–°
        Start.cmd

    # åˆ é™¤æ¯ç›˜ ISO
    - name: del MasterISO
      shell: cmd
      run: |
        cd /d D:\a\TestUpdate\Win_ISO_Patching_Scripts
        echo Before delete:
        dir *.iso

        del /F /Q *_windows_*_dvd_*.iso

        echo After delete:
        dir *.iso

    # ç§»åŠ¨ ISO åˆ°å½“å‰å·¥ä½œç›®å½•
    - name: Move ISO to Workspace
      shell: cmd
      run: |
        move "..\Win_ISO_Patching_Scripts\*.iso" .

    # è®¡ç®— CRC32 æ ¡éªŒå€¼ (è½¬å°å†™)
    - name: Calculate CRC32
      shell: pwsh
      run: |
        $iso = Get-ChildItem -Filter *.iso | Select-Object -First 1
        
        if (-not $iso) { 
            Write-Error "Error: No ISO file found." 
            exit 1 
        }
        Write-Host "Target ISO: $($iso.Name)"

        # 1. è®¡ç®— Hash (åŠ ä¸Š | Out-String è§£å†³æ•°ç»„æŠ¥é”™)
        $7zOutput = 7z h -scrcCRC32 $iso.Name | Out-String

        # 2. æå–å¹¶è½¬ä¸ºå°å†™
        if ($7zOutput -match 'for data:\s+([0-9A-F]{8})') {
            $crc = $matches[1].ToLower()
            
            Write-Host "Calculated CRC32: $crc"
            "CRC32=$crc" | Out-File -FilePath $env:GITHUB_ENV -Append
        } else {
            Write-Error "Error: Failed to parse CRC32 from 7-Zip output."
            exit 1
        }

    # ä¸Šä¼ é•œåƒ (ç›´æ¥ä¸Šä¼  Artifact)
    - uses: actions/upload-artifact@v4
      with:
        name: Win10_LTSC_2019_1809_${{env.Build_VERSION}}_x86_zh-cn_ITHaoge_${{env.CRC32}}
        path: "*.iso"