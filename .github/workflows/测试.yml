name: Debug_Version_Config

on: workflow_dispatch

jobs:
  Check_Version_Logic:
    runs-on: windows-latest

    steps:
    # 1. æ£€å‡ºä»“åº“ (ä¸ºäº†è·å– versions.json)
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. è¯»å– JSON å¹¶å†™å…¥ç¯å¢ƒå˜é‡
    - name: Read and Set Version
      shell: pwsh
      run: |
        # --- è¿™é‡Œè®¾ç½®ä½ è¦æµ‹è¯•çš„ Key ---
        $TargetKey = "LTSC2019"
        # ----------------------------

        $JsonFile = "versions.json"

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (-not (Test-Path $JsonFile)) {
            Write-Error "âŒ é”™è¯¯: æ‰¾ä¸åˆ° $JsonFile æ–‡ä»¶ï¼è¯·æ£€æŸ¥æ–‡ä»¶åå’Œä½ç½®ã€‚"
            exit 1
        }

        # è¯»å–å¹¶è§£æ JSON
        try {
            $config = Get-Content $JsonFile -Raw | ConvertFrom-Json
        } catch {
            Write-Error "âŒ JSON æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥é€—å·æˆ–æ‹¬å·æ˜¯å¦æ­£ç¡®ã€‚"
            Write-Error $_
            exit 1
        }

        # è·å–å¯¹åº” Key çš„å€¼
        $ver = $config.$TargetKey

        # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–åˆ°å€¼
        if (-not $ver) {
            Write-Error "âŒ é”™è¯¯: åœ¨ JSON ä¸­æ‰¾ä¸åˆ°é”®å€¼ '$TargetKey'"
            Write-Host "ğŸ’¡ å½“å‰ JSON åŒ…å«çš„æ‰€æœ‰é”®: $($config | Get-Member -MemberType NoteProperty | Select-Object -ExpandProperty Name)"
            exit 1
        }

        # æ‰“å°å¹¶å†™å…¥ç¯å¢ƒ
        Write-Host "âœ… è¯»å–æˆåŠŸï¼Key: $TargetKey"
        Write-Host "âœ… å¯¹åº”ç‰ˆæœ¬å·: $ver"
        
        "Build_VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append

    # 3. æœ€ç»ˆéªŒè¯ (æ¨¡æ‹Ÿåç»­æ­¥éª¤è¯»å–å˜é‡)
    - name: Verify Environment Variable
      shell: cmd
      run: |
        @echo off
        echo ---------------------------------------------------
        echo [Check Result]
        echo The environment variable Build_VERSION is:
        echo.
        echo     ${{ env.Build_VERSION }}
        echo.
        echo ---------------------------------------------------
        if "${{ env.Build_VERSION }}" == "" (
            echo âŒ FAILED: Variable is empty!
            exit 1
        ) else (
            echo âœ… SUCCESS: Variable works correctly!
        )