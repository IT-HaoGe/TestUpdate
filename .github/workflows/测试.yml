name: Debug_Version_Config (PSD1)

on: workflow_dispatch

jobs:
  Check_PSD1_Version:
    runs-on: windows-latest

    steps:
    # 1. æ£€å‡ºä»“åº“ (å¿…é¡»æ­¥éª¤ï¼Œå¦åˆ™æ‰¾ä¸åˆ°æ–‡ä»¶)
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. è¯»å– PSD1 å¹¶éªŒè¯
    - name: Read Version from PSD1
      shell: pwsh
      run: |
        # --- åœ¨è¿™é‡Œä¿®æ”¹ä½ æƒ³æµ‹è¯•çš„ Key ---
        $TargetKey = "LTSC2019"
        $Psd1File  = "versions.psd1"
        # ----------------------------

        # 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (-not (Test-Path $Psd1File)) {
            Write-Error "âŒ é”™è¯¯: æ‰¾ä¸åˆ° $Psd1File æ–‡ä»¶ï¼è¯·ç¡®è®¤æ–‡ä»¶åœ¨ä»“åº“æ ¹ç›®å½•ã€‚"
            exit 1
        }

        # 2. å®‰å…¨å¯¼å…¥ PSD1 æ•°æ®
        try {
            $data = Import-PowerShellDataFile -Path $Psd1File
        } catch {
            Write-Error "âŒ PSD1 æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯­æ³• (ä¾‹å¦‚æ˜¯å¦æ¼äº†å¼•å·æˆ–åˆ†å·)ã€‚"
            Write-Error $_
            exit 1
        }

        # 3. æ£€æŸ¥ Key æ˜¯å¦å­˜åœ¨
        if (-not $data.ContainsKey($TargetKey)) {
            Write-Error "âŒ é”™è¯¯: åœ¨ $Psd1File ä¸­æ‰¾ä¸åˆ°é”®å '$TargetKey'"
            Write-Host "ğŸ’¡ å½“å‰æ–‡ä»¶åŒ…å«çš„é”®: $($data.Keys -join ', ')"
            exit 1
        }

        # 4. è·å–å€¼å¹¶æ‰“å°
        $ver = $data[$TargetKey]
        
        Write-Host "----------------------------------------"
        Write-Host "âœ… è¯»å–æˆåŠŸï¼"
        Write-Host "ğŸ“‚ æ–‡ä»¶å: $Psd1File"
        Write-Host "ğŸ”‘ é”®å (Key): $TargetKey"
        Write-Host "ğŸ”¢ ç‰ˆæœ¬å· (Value): $ver"
        Write-Host "----------------------------------------"

        # 5. (å¯é€‰) å†™å…¥ç¯å¢ƒå˜é‡ï¼Œæ¨¡æ‹ŸçœŸå®åœºæ™¯
        "Build_VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append

    # 3. æœ€ç»ˆç¡®è®¤ç¯å¢ƒæ˜¯å¦ç”Ÿæ•ˆ
    - name: Verify Environment Variable
      shell: cmd
      run: |
        @echo off
        echo [Final Check]
        echo Build_VERSION is: %Build_VERSION%
        
        if "%Build_VERSION%" == "" (
            echo âŒ FAILED: Variable is empty!
            exit 1
        ) else (
            echo âœ… SUCCESS: Environment variable set correctly.
        )